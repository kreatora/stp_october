import"./input.js";import{r as i,j as s,R as Fe,a as Xe}from"./client.js";const M=220,ae=130,be=300,Ae=180,ye=900,Oe=()=>{const[h,Z]=i.useState("tree"),[E,ie]=i.useState(""),[D,A]=i.useState(null),[R,O]=i.useState(new Set),[xe,le]=i.useState(new Set),[G,we]=i.useState(new Set),[je,Ce]=i.useState(new Set),[u,U]=i.useState([]),[Ie,Ne]=i.useState([]),[S,Q]=i.useState(.6),[$,Y]=i.useState(0),[k,H]=i.useState(0),[B,re]=i.useState(!1),[J,Se]=i.useState({x:0,y:0}),[K,Ee]=i.useState({x:0,y:0}),[ce,_]=i.useState(null),[y,L]=i.useState(null),g=i.useRef(null),v=i.useRef(null),de=i.useRef(0),ue=i.useRef(0),z=i.useRef(null),he=i.useCallback(()=>{v.current&&(v.current.style.transform=`translate3d(${$}px, ${k}px, 0) scale(${S})`)},[$,k,S]);i.useEffect(()=>{he()},[he]);const P=i.useMemo(()=>"./ontology_interactive.pdf",[]);i.useEffect(()=>{let e=!1;return(async()=>{try{const n=await fetch(P,{method:"HEAD"});e||A(n.ok)}catch{e||A(!1)}})(),()=>{e=!0}},[P]);const Me=i.useCallback(async()=>{if(D===!1){window.alert("PDF not available yet. Drop the file in /public as ontology.pdf and it will enable automatically.");return}try{if(!(await fetch(P,{method:"HEAD"})).ok)throw new Error("PDF missing");A(!0);const n=document.createElement("a");n.href=P,n.download="ontology_interactive.pdf",document.body.appendChild(n),n.click(),n.remove()}catch{A(!1),window.alert("PDF not available yet. Drop the file in /public as ontology.pdf and it will enable automatically.")}},[D,P]),x=i.useCallback((e,n)=>{if(!e||e.length===0||!g.current)return;let t=1/0,o=1/0,c=-1/0,a=-1/0;e.forEach(b=>{t=Math.min(t,b.x),o=Math.min(o,b.y),c=Math.max(c,b.x+M),a=Math.max(a,b.y+ae)});const r=e.length>1?50:20;t-=r,o-=r,c+=r,a+=r;const l=g.current.offsetWidth,d=g.current.offsetHeight,f=c-t,p=a-o,m=t+f/2,N=o+p/2,j=n??Math.min(Math.min(l/f,d/p)*.95,1.5),C=v.current,I=++ue.current;if(C){C.style.transition=`transform ${ye}ms cubic-bezier(0.22, 1, 0.36, 1)`,z.current!=null&&(window.clearTimeout(z.current),z.current=null);const b=()=>{ue.current===I&&v.current&&(v.current.style.transition="none")},Pe=Te=>{Te.propertyName==="transform"&&b()};C.addEventListener("transitionend",Pe,{once:!0}),z.current=window.setTimeout(()=>{b()},ye+50)}Q(j),Y(l/2-m*j),H(d/2-N*j)},[Q,Y,H]),fe=i.useCallback(e=>{const n=[];e.forEach(t=>{if(t.parentId&&t.visible){const o=e.find(c=>c.id===t.parentId);o&&o.visible&&n.push({id:`conn-${o.id}-${t.id}`,x1:o.x+M/2,y1:o.y+ae,x2:t.x+M/2,y2:t.y,level:Math.min(o.level,5)})}}),Ne(n)},[]),ee=i.useCallback((e,n,t,o,c,a=!1)=>{const r=`node_${de.current++}`,l={...e,id:r,label:e.name,definition:e.definition||e.name,x:n,y:t,level:o,parentId:c,isRoot:a,visible:a,collapsed:!0,children:[]};let d=[l];if(e.children&&e.children.length>0){const f=e.children.length*be;let p=n+M/2-f/2;e.children.forEach(m=>{var I;const N=p,j=t+Ae,C=ee(m,N,j,o+1,r);(I=l.children)==null||I.push(...C.filter(b=>b.parentId===r)),d=d.concat(C),p+=be})}return d},[]);i.useEffect(()=>{const e="./ontology_tree.json";console.log(`Fetching data from: ${e}`),fetch(e).then(n=>{if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);return n.json()}).then(n=>{console.log("Fetched ontology data:",n),de.current=0;const t=Array.isArray(n)?n[0]:n;if(!t){console.error("Ontology data is empty or invalid.");return}const a=ee(t,50,50,0,null,!0);console.log("Processed nodes (full array):",a),console.log("Processed nodes length:",a.length),v.current&&(console.log("Visualization container width:",v.current.offsetWidth),console.log("Visualization container height:",v.current.offsetHeight)),a.slice(0,5).forEach(r=>{console.log(`Node ${r.id}: x=${r.x}, y=${r.y}, visible=${r.visible}, collapsed=${r.collapsed}`)}),U(a),a.length>0&&setTimeout(()=>{console.log("Initial centering on visible nodes");const r=a.filter(l=>l.visible);x(r)},100)}).catch(n=>console.error("Error loading ontology data:",n))},[ee,x]),i.useEffect(()=>{fe(u)},[u,fe]);const te=i.useCallback((e,n)=>{const t=[],o=[e],c=new Map;for(n.forEach(a=>{a.parentId&&(c.has(a.parentId)||c.set(a.parentId,[]),c.get(a.parentId).push(a.id))});o.length>0;){const a=o.pop(),r=c.get(a)||[];for(const l of r)t.push(l),o.push(l)}return t},[]),De=i.useCallback(e=>{U(n=>{const t=n.find(l=>l.id===e);if(!t)return n;L(t);let o=[...n];if(!t.children||t.children.length===0){if(ce===e){_(null);const l=o.find(d=>d.id===t.parentId);if(l){const d=o.filter(f=>f.parentId===l.id&&f.visible);x([l,...d])}else x([t])}else if(_(e),g.current){const d=g.current.getBoundingClientRect().width*.1,f=Math.min(d/M,.9);x([t],f)}return o}_(null);const a=!t.collapsed;if(a||o.filter(d=>d.parentId===t.parentId&&d.id!==e&&!d.collapsed).forEach(d=>{const f=te(d.id,o);o=o.map(p=>p.id===d.id?{...p,collapsed:!0,visible:!0}:f.includes(p.id)?{...p,visible:!1,hiddenByCollapse:!0,collapsed:!0}:p)}),o=o.map(l=>l.id===e?{...l,collapsed:a}:l.parentId===e&&a?{...l,visible:!1,hiddenByCollapse:!0}:l.parentId===e&&!a?{...l,visible:!0,hiddenByCollapse:!1}:l),a){const l=te(e,o);o=o.map(d=>l.includes(d.id)?{...d,visible:!1,hiddenByCollapse:!0,collapsed:!0}:d)}else o=o.map(l=>l.parentId===e?{...l,visible:!0,hiddenByCollapse:!1}:l);const r=o.filter(l=>l.parentId===e&&l.visible);return x(a?[t]:[t,...r]),o})},[ce,x,te]),Re=e=>{e.target!==g.current&&e.target!==v.current&&!e.target.classList.contains("visualization-container")||(re(!0),Se({x:e.clientX,y:e.clientY}),Ee({x:$,y:k}),g.current&&(g.current.style.cursor="grabbing"))},W=i.useCallback(e=>{if(!B)return;const n=e.clientX-J.x,t=e.clientY-J.y;Y(K.x+n),H(K.y+t)},[B,J,K]),V=i.useCallback(()=>{re(!1),g.current&&(g.current.style.cursor="grab")},[]);i.useEffect(()=>(B?(document.addEventListener("mousemove",W),document.addEventListener("mouseup",V)):(document.removeEventListener("mousemove",W),document.removeEventListener("mouseup",V)),()=>{document.removeEventListener("mousemove",W),document.removeEventListener("mouseup",V)}),[B,W,V]);const ne=i.useCallback(e=>{if(!g.current)return;e.preventDefault();const n=g.current.getBoundingClientRect(),t=e.clientX-n.left,o=e.clientY-n.top,c=(t-$)/S,a=(o-k)/S,r=1.05;let l;e.deltaY<0?l=Math.min(S*r,1.5):l=Math.max(S/r,.3);const d=t-c*l,f=o-a*l;Q(l),Y(d),H(f)},[$,k,S]);i.useEffect(()=>{if(h!=="tree")return;const e=g.current;if(e)return e.addEventListener("wheel",ne,{passive:!1}),()=>{e.removeEventListener("wheel",ne)}},[ne,h]);const se=i.useCallback(()=>{_(null),L(null),U(e=>{const n=e.find(o=>o.isRoot);if(!n)return e;const t=e.map(o=>({...o,visible:!!o.isRoot,collapsed:!0,hiddenByCollapse:!1}));return setTimeout(()=>x([n]),0),t})},[x]),pe=i.useRef(h);i.useEffect(()=>{const e=pe.current;h==="tree"&&e!=="tree"&&se(),pe.current=h},[h,se]);const q=i.useMemo(()=>{if(!u||u.length===0)return[];const e=new Map(u.map(t=>[t.id,t])),n=t=>{const o=[],c=new Set;let a=t;for(;a&&!c.has(a.id);)c.add(a.id),o.push(a.name),a=a.parentId?e.get(a.parentId):void 0;return o.reverse().join(" › ")};return u.map(t=>{var c;const o=t.parentId?((c=e.get(t.parentId))==null?void 0:c.name)??"—":"—";return{node:t,parentName:o,path:n(t)}}).sort((t,o)=>t.path.localeCompare(o.path))},[u]),oe=i.useMemo(()=>{const e=E.trim().toLowerCase();return e?q.filter(n=>{var a,r;const t=((a=n.node.name)==null?void 0:a.toLowerCase())??"",o=((r=n.node.definition)==null?void 0:r.toLowerCase())??"",c=n.path.toLowerCase();return t.includes(e)||o.includes(e)||c.includes(e)}):q},[E,q]),$e=i.useMemo(()=>{if(h!=="tree")return new Set;const e=u.filter(c=>c.visible),n=new Set,t=M,o=ae;for(let c=0;c<e.length;c++){const a=e[c],r=a.x,l=a.y,d=a.x+t,f=a.y+o;for(let p=c+1;p<e.length;p++){const m=e[p],N=m.x,j=m.y,C=m.x+t,I=m.y+o;r<C&&d>N&&l<I&&f>j&&(n.add(a.id),n.add(m.id))}}return n},[u,h]),w=i.useMemo(()=>new Map(u.map(e=>[e.id,e])),[u]),T=i.useMemo(()=>{const e=new Map;for(const n of u){if(!n.parentId)continue;const t=n.parentId;e.has(t)||e.set(t,[]),e.get(t).push(n.id)}for(const[n,t]of e.entries())t.sort((o,c)=>{var a,r;return(((a=w.get(o))==null?void 0:a.name)??"").localeCompare(((r=w.get(c))==null?void 0:r.name)??"")}),e.set(n,t);return e},[u,w]);i.useEffect(()=>{u.length&&O(e=>{if(e.size>0)return e;const n=new Set;for(const t of u)t.isRoot&&n.add(t.id);return n})},[u]);const ke=i.useCallback(e=>{O(n=>{const t=new Set(n),o=t.has(e);if(o?t.delete(e):t.add(e),!o){const c=T.get(e)??[];c.length&&(le(new Set(c)),window.setTimeout(()=>le(new Set),180))}return t})},[T]),Le=i.useCallback(e=>{we(n=>{const t=new Set(n);return t.has(e)?t.delete(e):t.add(e),t})},[]),me=i.useRef(new Map),ge=i.useCallback(e=>{if(!e){O(new Set(u.filter(n=>n.isRoot).map(n=>n.id)));return}O(new Set(u.map(n=>n.id)))},[u]),F=i.useMemo(()=>{var o,c;const e=E.trim().toLowerCase();if(!e)return null;const n=new Set;for(const a of u){const r=((o=a.name)==null?void 0:o.toLowerCase())??"",l=((c=a.definition)==null?void 0:c.toLowerCase())??"";(r.includes(e)||l.includes(e))&&n.add(a.id)}const t=new Set;for(const a of n){let r=w.get(a);for(;r&&!t.has(r.id);)t.add(r.id),r=r.parentId?w.get(r.parentId):void 0}return t},[u,w,E]),X=i.useMemo(()=>{var o,c;if(!u.length)return[];const e=u.filter(a=>a.isRoot||!a.parentId).sort((a,r)=>a.name.localeCompare(r.name)),n=[],t=e.map(a=>({id:a.id,depth:0})).reverse();for(;t.length;){const{id:a,depth:r}=t.pop(),l=w.get(a);if(!l||F&&!F.has(a))continue;const d=l.parentId?((o=w.get(l.parentId))==null?void 0:o.name)??"—":"—",f=(((c=T.get(l.id))==null?void 0:c.length)??0)>0,p=[];let m=l;const N=new Set;for(;m&&!N.has(m.id);)N.add(m.id),p.push(m.name),m=m.parentId?w.get(m.parentId):void 0;const j=p.reverse().join(" › ");if(n.push({node:l,parentName:d,path:j,depth:r,hasChildren:f}),f&&(F?!0:R.has(l.id))){const I=T.get(l.id)??[];for(let b=I.length-1;b>=0;b--)t.push({id:I[b],depth:r+1})}}return n},[u,w,T,R,F]);return i.useEffect(()=>{if(h!=="tableInteractive")return;const e=window.requestAnimationFrame(()=>{const n=new Set;for(const t of X){const o=me.current.get(t.node.id);o&&o.scrollHeight>o.clientHeight+1&&n.add(t.node.id)}Ce(n)});return()=>window.cancelAnimationFrame(e)},[X,h]),s.jsxs("div",{className:"viewport",ref:g,onMouseDown:Re,children:[s.jsxs("div",{className:"ontology-toolbar",role:"toolbar","aria-label":"Ontology controls",children:[s.jsxs("div",{className:"view-toggle",role:"tablist","aria-label":"Switch view",children:[s.jsx("button",{type:"button",role:"tab","aria-selected":h==="tree",className:`view-toggle-button ${h==="tree"?"active":""}`,onClick:()=>Z("tree"),children:"Tree view"}),s.jsx("button",{type:"button",role:"tab","aria-selected":h==="table",className:`view-toggle-button ${h==="table"?"active":""}`,onClick:()=>Z("table"),children:"Table (static)"}),s.jsx("button",{type:"button",role:"tab","aria-selected":h==="tableInteractive",className:`view-toggle-button ${h==="tableInteractive"?"active":""}`,onClick:()=>Z("tableInteractive"),children:"Table (interactive)"})]}),s.jsx("div",{className:"toolbar-right",children:s.jsxs("div",{className:"pdf-cta",children:[s.jsx("span",{className:"pdf-cta-text",children:"Download ontology as PDF"}),s.jsx("button",{type:"button",className:`pdf-button ${D===!1?"disabled":""}`,onClick:Me,disabled:D===!1,title:D===!1?"PDF not uploaded yet":"Download ontology as PDF",children:"PDF"})]})})]}),h==="tree"?s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"visualization-container",ref:v,children:[u.filter(e=>e.visible).map(e=>s.jsxs("div",{className:`card ${e.isRoot?"root-card":""} ${e.collapsed?"collapsed":""} ${(y==null?void 0:y.id)===e.id?"selected":""} ${$e.has(e.id)?"overlapping":""}`,style:{left:`${e.x}px`,top:`${e.y}px`},onClick:n=>{n.stopPropagation(),De(e.id)},"data-id":e.id,"data-level":e.level,"data-parent-id":e.parentId,children:[s.jsx("div",{className:"card-name",children:e.name}),e.children&&e.children.length>0&&s.jsx("div",{className:"expand-icon"})]},e.id)),Ie.map(e=>s.jsx("div",{className:`connection-line connection-line-level-${e.level}`,style:{width:`${Math.sqrt(Math.pow(e.x2-e.x1,2)+Math.pow(e.y2-e.y1,2))}px`,left:`${e.x1}px`,top:`${e.y1}px`,transform:`rotate(${Math.atan2(e.y2-e.y1,e.x2-e.x1)*180/Math.PI}deg)`}},e.id))]}),s.jsx("div",{className:"zoom-controls",children:s.jsx("button",{className:"reset-button",onClick:se,children:"Reset"})})]}):h==="table"?s.jsxs("div",{className:"ontology-table-wrap",role:"region","aria-label":"Ontology table",children:[s.jsxs("div",{className:"ontology-table-controls",children:[s.jsxs("div",{className:"ontology-search",children:[s.jsx("label",{className:"ontology-search-label",htmlFor:"ontology-search-input",children:"Search"}),s.jsx("input",{id:"ontology-search-input",className:"ontology-search-input",value:E,onChange:e=>ie(e.target.value),placeholder:"Search concepts, definitions, paths…"})]}),s.jsxs("div",{className:"ontology-table-meta",children:[oe.length.toLocaleString()," / ",q.length.toLocaleString()," concepts"]})]}),s.jsx("div",{className:"ontology-table-card",children:s.jsxs("table",{className:"ontology-table",children:[s.jsx("thead",{children:s.jsxs("tr",{children:[s.jsx("th",{children:"Concept"}),s.jsx("th",{children:"Parent"}),s.jsx("th",{children:"Level"}),s.jsx("th",{children:"Definition"})]})}),s.jsxs("tbody",{children:[oe.map(e=>s.jsxs("tr",{className:(y==null?void 0:y.id)===e.node.id?"selected":"",onClick:()=>L(e.node),children:[s.jsx("td",{children:s.jsxs("div",{className:"ontology-table-concept",children:[s.jsx("div",{className:"ontology-table-name",children:e.node.name}),s.jsx("div",{className:"ontology-table-path",children:e.path})]})}),s.jsx("td",{className:"ontology-table-parent",children:e.parentName}),s.jsx("td",{className:"ontology-table-level",children:e.node.level}),s.jsx("td",{children:s.jsx("div",{className:"ontology-table-definition",children:e.node.definition})})]},e.node.id)),oe.length===0&&s.jsx("tr",{children:s.jsx("td",{colSpan:4,className:"ontology-table-empty",children:"No results. Try a different search query."})})]})]})})]}):s.jsxs("div",{className:"ontology-table-wrap",role:"region","aria-label":"Interactive ontology table",children:[s.jsxs("div",{className:"ontology-table-controls",children:[s.jsxs("div",{className:"ontology-search",children:[s.jsx("label",{className:"ontology-search-label",htmlFor:"ontology-search-input",children:"Search"}),s.jsx("input",{id:"ontology-search-input",className:"ontology-search-input",value:E,onChange:e=>ie(e.target.value),placeholder:"Search concepts, definitions…"})]}),s.jsxs("div",{className:"ontology-table-actions",children:[s.jsx("button",{type:"button",className:"ontology-mini-button",onClick:()=>ge(!0),children:"Expand all"}),s.jsx("button",{type:"button",className:"ontology-mini-button",onClick:()=>ge(!1),children:"Collapse all"})]}),s.jsxs("div",{className:"ontology-table-meta",children:[X.length.toLocaleString()," concepts"]})]}),s.jsx("div",{className:"ontology-table-card",children:s.jsxs("table",{className:"ontology-table ontology-table-interactive",children:[s.jsx("thead",{children:s.jsxs("tr",{children:[s.jsx("th",{children:"Concept"}),s.jsx("th",{children:"Parent"}),s.jsx("th",{children:"Level"}),s.jsx("th",{children:"Definition"})]})}),s.jsxs("tbody",{children:[X.map(e=>s.jsxs("tr",{className:[(y==null?void 0:y.id)===e.node.id?"selected":"",xe.has(e.node.id)?"just-revealed":""].filter(Boolean).join(" "),onClick:()=>L(e.node),children:[s.jsx("td",{children:s.jsxs("div",{className:"ontology-interactive-cell",children:[e.depth>0?s.jsx("span",{className:"ontology-indent-guides",style:{width:`${e.depth*18}px`},"aria-hidden":"true"}):null,e.hasChildren?s.jsx("button",{type:"button",className:"ontology-disclosure","aria-label":R.has(e.node.id)?"Collapse":"Expand","aria-expanded":R.has(e.node.id),onClick:n=>{n.stopPropagation(),ke(e.node.id)},children:F||R.has(e.node.id)?"▾":"▸"}):s.jsx("span",{className:"ontology-disclosure-spacer","aria-hidden":"true"}),s.jsxs("div",{className:"ontology-table-concept",children:[s.jsx("div",{className:"ontology-table-name",children:e.node.name}),s.jsx("div",{className:"ontology-table-path",children:e.path})]})]})}),s.jsx("td",{className:"ontology-table-parent",children:e.parentName}),s.jsx("td",{className:"ontology-table-level",children:e.node.level}),s.jsx("td",{children:s.jsxs("div",{className:"ontology-definition-cell",children:[s.jsx("div",{ref:n=>{const t=me.current;n?t.set(e.node.id,n):t.delete(e.node.id)},className:`ontology-table-definition ${G.has(e.node.id)?"expanded":""}`,children:e.node.definition}),G.has(e.node.id)||je.has(e.node.id)?s.jsx("button",{type:"button",className:"ontology-more-button",onClick:n=>{n.stopPropagation(),Le(e.node.id)},children:G.has(e.node.id)?"Less":"More"}):null]})})]},e.node.id)),X.length===0&&s.jsx("tr",{children:s.jsx("td",{colSpan:4,className:"ontology-table-empty",children:"No results. Try a different search query."})})]})]})})]}),h==="tree"&&y&&s.jsxs("div",{className:"definition-panel",children:[s.jsx("h3",{className:"panel-title",children:y.name}),s.jsx("p",{className:"panel-definition",children:y.definition}),s.jsx("button",{className:"close-panel-button",onClick:()=>L(null),children:"X"})]})]})},ve=document.getElementById("ontology-container");ve?Fe.createRoot(ve).render(s.jsx(Xe.StrictMode,{children:s.jsx(Oe,{})})):console.error("Failed to find the ontology-container element.");
