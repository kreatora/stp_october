import"./input.js";import{r,j as d,R as se,a as ie}from"./client.js";const w=220,F=130,V=300,oe=180,re=()=>{const[x,E]=r.useState([]),[U,q]=r.useState([]),[g,D]=r.useState(.6),[C,M]=r.useState(0),[b,R]=r.useState(0),[$,_]=r.useState(!1),[Y,J]=r.useState({x:0,y:0}),[H,K]=r.useState({x:0,y:0}),[k,S]=r.useState(null),[y,P]=r.useState(null),u=r.useRef(null),h=r.useRef(null),T=r.useRef(0),W=r.useCallback(()=>{h.current&&(h.current.style.transform=`translate3d(${C}px, ${b}px, 0) scale(${g})`)},[C,b,g]);r.useEffect(()=>{W()},[W]);const m=r.useCallback((e,i)=>{if(!e||e.length===0||!u.current)return;let t=1/0,s=1/0,c=-1/0,o=-1/0;e.forEach(v=>{t=Math.min(t,v.x),s=Math.min(s,v.y),c=Math.max(c,v.x+w),o=Math.max(o,v.y+F)});const a=e.length>1?50:20;t-=a,s-=a,c+=a,o+=a;const n=u.current.offsetWidth,l=u.current.offsetHeight,f=c-t,p=o-s,z=t+f/2,B=s+p/2,I=i??Math.min(Math.min(n/f,l/p)*.95,1.5);D(I),M(n/2-z*I),R(l/2-B*I),h.current&&(h.current.style.transition="transform 0.5s ease-out",setTimeout(()=>{h.current&&(h.current.style.transition="none")},500))},[D,M,R]),A=r.useCallback(e=>{const i=[];e.forEach(t=>{if(t.parentId&&t.visible){const s=e.find(c=>c.id===t.parentId);s&&s.visible&&i.push({id:`conn-${s.id}-${t.id}`,x1:s.x+w/2,y1:s.y+F,x2:t.x+w/2,y2:t.y,level:Math.min(s.level,5)})}}),q(i)},[]),L=r.useCallback((e,i,t,s,c,o=!1)=>{const a=`node_${T.current++}`,n={...e,id:a,label:e.name,definition:e.definition||e.name,x:i,y:t,level:s,parentId:c,isRoot:o,visible:o,collapsed:!0,children:[]};let l=[n];if(e.children&&e.children.length>0){const f=e.children.length*V;let p=i+w/2-f/2;e.children.forEach(z=>{var Z;const B=p,I=t+oe,v=L(z,B,I,s+1,a);(Z=n.children)==null||Z.push(...v.filter(ne=>ne.parentId===a)),l=l.concat(v),p+=V})}return l},[]);r.useEffect(()=>{const e="/stp_o/ontology_tree.json";console.log(`Fetching data from: ${e}`),fetch(e).then(i=>{if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);return i.json()}).then(i=>{console.log("Fetched ontology data:",i),T.current=0;const t=Array.isArray(i)?i[0]:i;if(!t){console.error("Ontology data is empty or invalid.");return}const o=L(t,50,50,0,null,!0);console.log("Processed nodes (full array):",o),console.log("Processed nodes length:",o.length),h.current&&(console.log("Visualization container width:",h.current.offsetWidth),console.log("Visualization container height:",h.current.offsetHeight)),o.slice(0,5).forEach(a=>{console.log(`Node ${a.id}: x=${a.x}, y=${a.y}, visible=${a.visible}, collapsed=${a.collapsed}`)}),E(o),o.length>0&&setTimeout(()=>{console.log("Initial centering on visible nodes");const a=o.filter(n=>n.visible);m(a)},100)}).catch(i=>console.error("Error loading ontology data:",i))},[L,m]),r.useEffect(()=>{A(x)},[x,A]);const N=r.useCallback((e,i)=>{const t=[],s=[e],c=new Map;for(i.forEach(o=>{o.parentId&&(c.has(o.parentId)||c.set(o.parentId,[]),c.get(o.parentId).push(o.id))});s.length>0;){const o=s.pop(),a=c.get(o)||[];for(const n of a)t.push(n),s.push(n)}return t},[]),Q=r.useCallback(e=>{E(i=>{const t=i.find(n=>n.id===e);if(!t)return i;P(t);let s=[...i];if(!t.children||t.children.length===0){if(k===e){S(null);const n=s.find(l=>l.id===t.parentId);if(n){const l=s.filter(f=>f.parentId===n.id&&f.visible);m([n,...l])}else m([t])}else if(S(e),u.current){const l=u.current.getBoundingClientRect().width*.1,f=Math.min(l/w,.9);m([t],f)}return s}S(null);const o=!t.collapsed;if(o||s.filter(l=>l.parentId===t.parentId&&l.id!==e&&!l.collapsed).forEach(l=>{const f=N(l.id,s);s=s.map(p=>p.id===l.id?{...p,collapsed:!0,visible:!0}:f.includes(p.id)?{...p,visible:!1,hiddenByCollapse:!0,collapsed:!0}:p)}),s=s.map(n=>n.id===e?{...n,collapsed:o}:n.parentId===e&&o?{...n,visible:!1,hiddenByCollapse:!0}:n.parentId===e&&!o?{...n,visible:!0,hiddenByCollapse:!1}:n),o){const n=N(e,s);s=s.map(l=>n.includes(l.id)?{...l,visible:!1,hiddenByCollapse:!0,collapsed:!0}:l)}else s=s.map(n=>n.parentId===e?{...n,visible:!0,hiddenByCollapse:!1}:n);const a=s.filter(n=>n.parentId===e&&n.visible);return m(o?[t]:[t,...a]),s})},[k,m,N]),ee=e=>{e.target!==u.current&&e.target!==h.current&&!e.target.classList.contains("visualization-container")||(_(!0),J({x:e.clientX,y:e.clientY}),K({x:C,y:b}),u.current&&(u.current.style.cursor="grabbing"))},j=r.useCallback(e=>{if(!$)return;const i=e.clientX-Y.x,t=e.clientY-Y.y;M(H.x+i),R(H.y+t)},[$,Y,H]),X=r.useCallback(()=>{_(!1),u.current&&(u.current.style.cursor="grab")},[]);r.useEffect(()=>($?(document.addEventListener("mousemove",j),document.addEventListener("mouseup",X)):(document.removeEventListener("mousemove",j),document.removeEventListener("mouseup",X)),()=>{document.removeEventListener("mousemove",j),document.removeEventListener("mouseup",X)}),[$,j,X]);const O=r.useCallback(e=>{if(!u.current)return;e.preventDefault();const i=u.current.getBoundingClientRect(),t=e.clientX-i.left,s=e.clientY-i.top,c=(t-C)/g,o=(s-b)/g,a=1.05;let n;e.deltaY<0?n=Math.min(g*a,1.5):n=Math.max(g/a,.3);const l=t-c*n,f=s-o*n;D(n),M(l),R(f)},[C,b,g]);r.useEffect(()=>{const e=u.current;return e&&e.addEventListener("wheel",O,{passive:!1}),()=>{e&&e.removeEventListener("wheel",O)}},[O]);const te=r.useCallback(()=>{const e=x.find(i=>i.isRoot);e&&(console.log("Resetting zoom to root:",e),S(null),E(i=>i.map(t=>({...t,visible:!0,collapsed:!t.isRoot,hiddenByCollapse:!1}))),m([e]))},[x,m,E]);return d.jsxs("div",{className:"viewport",ref:u,onMouseDown:ee,children:[d.jsxs("div",{className:"visualization-container",ref:h,children:[x.filter(e=>e.visible).map(e=>d.jsxs("div",{className:`card ${e.isRoot?"root-card":""} ${e.collapsed?"collapsed":""} ${(y==null?void 0:y.id)===e.id?"selected":""}`,style:{left:`${e.x}px`,top:`${e.y}px`},onClick:i=>{i.stopPropagation(),Q(e.id)},"data-id":e.id,"data-level":e.level,"data-parent-id":e.parentId,children:[d.jsx("div",{className:"card-name",children:e.name}),e.children&&e.children.length>0&&d.jsx("div",{className:"expand-icon"})]},e.id)),U.map(e=>d.jsx("div",{className:`connection-line connection-line-level-${e.level}`,style:{width:`${Math.sqrt(Math.pow(e.x2-e.x1,2)+Math.pow(e.y2-e.y1,2))}px`,left:`${e.x1}px`,top:`${e.y1}px`,transform:`rotate(${Math.atan2(e.y2-e.y1,e.x2-e.x1)*180/Math.PI}deg)`}},e.id))]}),d.jsx("div",{className:"zoom-controls",children:d.jsx("button",{className:"reset-button",onClick:te,children:"Reset"})}),y&&d.jsxs("div",{className:"definition-panel",children:[d.jsx("h3",{className:"panel-title",children:y.name}),d.jsx("p",{className:"panel-definition",children:y.definition}),d.jsx("button",{className:"close-panel-button",onClick:()=>P(null),children:"X"})]})]})},G=document.getElementById("ontology-container");G?se.createRoot(G).render(d.jsx(ie.StrictMode,{children:d.jsx(re,{})})):console.error("Failed to find the ontology-container element.");
